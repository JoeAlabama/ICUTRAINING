<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>אימון טיפול נמרץ נוירולוגי</title>
<style>
  :root{--bg:#0b1320;--panel:#0f172a;--ink:#e2e8f0;--muted:#94a3b8;--cyan:#38bdf8;--cyan-strong:#22d3ee;--green:#22c55e;--red:#ef4444}
  html,body{height:100%;background:#111827;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;color:var(--ink)}
  /* Start overlay */
  #startOverlay{position:fixed;inset:0;background:linear-gradient(180deg,#0b1320,#0f172a);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:var(--ink)}
  #startOverlay h2{margin:0 0 12px 0;font-size:28px;letter-spacing:.3px}
  #startOverlay .ekg{position:relative;width:min(1200px,92vw);height:100px;border:1px solid #1f2937;border-radius:12px;background:#071018;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #startOverlay .strip{position:absolute;left:0;top:0;height:100%;width:300%;display:flex;will-change:transform;animation:scrollX 6s linear infinite}
  #startOverlay svg{flex:1;height:100%;width:33.3333%}
  #startOverlay polyline{stroke:#22c55e;stroke-width:3;fill:none;stroke-linejoin:round;stroke-linecap:round;filter:drop-shadow(0 0 8px rgba(34,197,94,.5));shape-rendering:geometricPrecision;vector-effect:non-scaling-stroke}
  @keyframes scrollX{from{transform:translateX(0)}to{transform:translateX(-33.3333%)}}
  #startBtn{margin-top:16px;background:var(--green);color:#041318;border:none;border-radius:12px;padding:12px 20px;font-weight:800;cursor:pointer;box-shadow:0 8px 22px rgba(16,185,129,.25)}
  /* Translate toggle button */
  #translateBtn{position:fixed;top:10px;right:10px;z-index:10000;background:var(--cyan);color:#041318;border:none;border-radius:10px;padding:8px 14px;font-weight:800;cursor:pointer;box-shadow:0 8px 22px rgba(56,189,248,.25)}
  /* Game wrapper */
  #gameWrapper{display:none}
  #icuScene{position:relative;width:100vw;height:100vh;background:#1e293b;overflow:hidden}
  /* HUD */
  #hud{position:absolute;top:0;width:100%;height:40vh;background:var(--panel);color:var(--ink);display:flex;flex-direction:column;align-items:center;gap:10px;justify-content:flex-start;padding-top:14px;box-shadow:0 4px 12px rgba(0,0,0,0.5);z-index:5}
  #hud h1{margin:0;font-size:22px}
  #hud .chips{display:flex;gap:16px;align-items:center}
  #hud .chip{font-size:1.05em;background:#111827;border:1px solid #374151;border-radius:10px;padding:6px 10px}
  #questionBanner{width:min(820px,92vw);background:#111827;border:1px solid #374151;border-radius:12px;padding:10px 12px;font-size:1em;opacity:0.9;text-align:center}
  /* Nurse, beds */
  #nurse{position:absolute;top:65vh;left:45%;width:140px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.6));transition:transform .25s ease-out}
  @keyframes breathe {0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
  #nurse.idle{animation:breathe 2.2s ease-in-out infinite}
  .bed{position:absolute;width:200px;z-index:2}
  .bed.glow{animation:pulseGlow 1.2s ease-in-out infinite}
  @keyframes pulseGlow{0%{filter:drop-shadow(0 0 0 rgba(56,189,248,0));box-shadow:0 0 8px 2px rgba(56,189,248,.25)}50%{filter:drop-shadow(0 0 12px rgba(56,189,248,.9));box-shadow:0 0 18px 8px rgba(56,189,248,.65)}100%{filter:drop-shadow(0 0 0 rgba(56,189,248,0));box-shadow:0 0 8px 2px rgba(56,189,248,.25)}}
  /* Center prop */
  #centerSprite{position:absolute;top:70vh;left:50%;transform:translateX(-50%);width:220px;z-index:1;filter:drop-shadow(0 8px 14px rgba(0,0,0,.55))}
  /* Callouts */
  #helpText{position:absolute;display:none;font-size:1.1em;font-weight:700;color:var(--cyan);text-shadow:0 0 6px #000;animation:helpAnim 1s infinite alternate;z-index:4}
  @keyframes helpAnim{from{transform:scale(1)}to{transform:scale(1.12)}}
  .travelMsg{position:absolute;color:#a7f3d0;background:rgba(6,78,59,0.2);border:1px solid rgba(16,185,129,0.35);padding:4px 8px;border-radius:8px;font-weight:700;pointer-events:none;z-index:4;animation:msgFade 900ms ease-out forwards;text-shadow:0 0 6px rgba(0,0,0,0.5)}
  @keyframes msgFade{from{opacity:1;transform:translate(-50%,-100%) translateY(0)}to{opacity:0;transform:translate(-50%,-100%) translateY(-10px)}}
  /* Modal */
  #questionModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:10}
  #questionModal .card{background:#0b1320;color:#e2e8f0;padding:22px;border-radius:14px;max-width:560px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  #options{display:grid;gap:8px;margin-top:6px}
  #nextBtn{display:none;background:#22c55e;border:none;color:#041318;padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer}
</style>
</head>
<body>
  <!-- Start Overlay BEFORE the game markup -->
  <button id="translateBtn">English</button>
  <div id="startOverlay">
    <h2>אימון טיפול נמרץ נוירולוגי</h2>
    <div class="ekg">
      <div class="strip">
        <svg viewBox="0 0 1000 100" preserveAspectRatio="none"><polyline points="0,50 40,50 55,46 60,85 65,22 70,90 75,50 130,50 145,46 150,85 155,22 160,90 165,50 220,50 235,46 240,85 245,22 250,90 255,50 310,50 325,46 330,85 335,22 340,90 345,50 400,50 420,48 435,70 450,50 470,50 485,46 490,85 495,22 500,90 505,50 560,50 575,46 580,85 585,22 590,90 595,50 650,50 665,46 670,85 675,22 680,90 685,50 740,50 755,46 760,85 765,22 770,90 775,50 830,50 845,46 850,85 855,22 860,90 865,50 920,50 935,46 940,85 945,22 950,90 955,50 1000,50"></polyline></svg>
        <svg viewBox="0 0 1000 100" preserveAspectRatio="none"><polyline points="0,50 40,50 55,46 60,85 65,22 70,90 75,50 130,50 145,46 150,85 155,22 160,90 165,50 220,50 235,46 240,85 245,22 250,90 255,50 310,50 325,46 330,85 335,22 340,90 345,50 400,50 420,48 435,70 450,50 470,50 485,46 490,85 495,22 500,90 505,50 560,50 575,46 580,85 585,22 590,90 595,50 650,50 665,46 670,85 675,22 680,90 685,50 740,50 755,46 760,85 765,22 770,90 775,50 830,50 845,46 850,85 855,22 860,90 865,50 920,50 935,46 940,85 945,22 950,90 955,50 1000,50"></polyline></svg>
        <svg viewBox="0 0 1000 100" preserveAspectRatio="none"><polyline points="0,50 40,50 55,46 60,85 65,22 70,90 75,50 130,50 145,46 150,85 155,22 160,90 165,50 220,50 235,46 240,85 245,22 250,90 255,50 310,50 325,46 330,85 335,22 340,90 345,50 400,50 420,48 435,70 450,50 470,50 485,46 490,85 495,22 500,90 505,50 560,50 575,46 580,85 585,22 590,90 595,50 650,50 665,46 670,85 675,22 680,90 685,50 740,50 755,46 760,85 765,22 770,90 775,50 830,50 845,46 850,85 855,22 860,90 865,50 920,50 935,46 940,85 945,22 950,90 955,50 1000,50"></polyline></svg>
      </div>
    </div>
    <button id="startBtn">התחל משחק</button>
  </div>

  <!-- GAME -->
  <div id="gameWrapper">
    <div id="icuScene">
      <!-- HUD -->
      <div id="hud">
        <h1>אימון טיפול נמרץ נוירולוגי</h1>
        <div class="chips">
          <div id="score" class="chip">ניקוד: <span>0</span></div>
          <div id="timer" class="chip">זמן: <span>00:00</span></div>
        </div>
        <div id="questionBanner">התקרב למיטה הזוהרת כדי לקבל תרחיש.</div>
      </div>

      <!-- Nurse -->
      <img id="nurse" class="idle" src="https://i.postimg.cc/L8J169pK/Chat-GPT-Image-Jul-9-2025-12-24-56-PM.png" alt="nurse" />

      <!-- Beds along left wall -->
      <img class="bed" data-idx="0" src="https://i.postimg.cc/TwyJWVm0/Chat-GPT-Image-Jul-9-2025-12-03-56-PM.png" style="top:50vh;left:5%" alt="bed" />
      <img class="bed" data-idx="1" src="https://i.postimg.cc/TwyJWVm0/Chat-GPT-Image-Jul-9-2025-12-03-56-PM.png" style="top:66vh;left:5%" alt="bed" />
      <img class="bed" data-idx="2" src="https://i.postimg.cc/TwyJWVm0/Chat-GPT-Image-Jul-9-2025-12-03-56-PM.png" style="top:82vh;left:5%" alt="bed" />

      <!-- Beds along right wall -->
      <img class="bed" data-idx="3" src="https://i.postimg.cc/TwyJWVm0/Chat-GPT-Image-Jul-9-2025-12-03-56-PM.png" style="top:50vh;right:5%" alt="bed" />
      <img class="bed" data-idx="4" src="https://i.postimg.cc/TwyJWVm0/Chat-GPT-Image-Jul-9-2025-12-03-56-PM.png" style="top:66vh;right:5%" alt="bed" />
      <img class="bed" data-idx="5" src="https://i.postimg.cc/TwyJWVm0/Chat-GPT-Image-Jul-9-2025-12-03-56-PM.png" style="top:82vh;right:5%" alt="bed" />

      <!-- Center sprite between beds -->
      <img id="centerSprite" src="https://i.postimg.cc/tT4t2pPr/95fe5022-5441-42b8-9358-7332df4ea755.png" alt="center sprite" />

      <!-- Help text -->
      <div id="helpText">עזרה, אחות!</div>
    </div>

    <!-- Modal -->
    <div id="questionModal">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3 id="modalTitle" style="margin:0;font-size:20px;">בדיקה קלינית</h3>
          <button id="closeModalBtn" style="background:#1f2937;color:#e5e7eb;border:none;border-radius:8px;padding:6px 10px;cursor:pointer">✕</button>
        </div>
        <p id="questionText" style="margin:0 0 12px 0;line-height:1.4"></p>
        <div id="options"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;">
          <div id="resultMsg" style="min-height:22px;font-size:14px;opacity:.9"></div>
          <button id="nextBtn">הבא</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== Language packs (30 Q each) =====
const QUESTIONS_EN=[
  {q:'What is the normal range for intracranial pressure (ICP) in adults?',correct:'5–15 mmHg',incorrect:['0–5 mmHg','15–25 mmHg','25–35 mmHg']},
  {q:'Which of the following is a common sign of increased ICP?',correct:"Cushing’s triad",incorrect:['Hyperreflexia','Bradypnea with alkalosis','Miosis']},
  {q:'What Glasgow Coma Scale score indicates severe brain injury?',correct:'3–8',incorrect:['13–15','9–12','0–3']},
  {q:'Which medication is first-line to rapidly reduce acutely elevated ICP?',correct:'Mannitol',incorrect:['Furosemide','Nifedipine','Lorazepam']},
  {q:'A patient with a newly dilated, non-reactive unilateral pupil most likely has:',correct:'Uncal herniation',incorrect:['Epidural hematoma without herniation','Cerebellar stroke','Optic neuritis']},
  {q:'In a hypotensive TBI patient needing osmotherapy, which agent is preferred?',correct:'3% hypertonic saline',incorrect:['Mannitol','D5W','0.45% saline']},
  {q:'During brief hyperventilation for impending herniation, target PaCO₂ is:',correct:'30–35 mmHg',incorrect:['20–25 mmHg','35–40 mmHg','45–50 mmHg']},
  {q:'Cerebral perfusion pressure (CPP) is calculated as:',correct:'MAP − ICP',incorrect:['ICP − MAP','MAP + ICP','SBP − ICP']},
  {q:'Recommended adult CPP target in severe TBI is typically:',correct:'60–70 mmHg',incorrect:['40–50 mmHg','80–90 mmHg','30–40 mmHg']},
  {q:'Which finding suggests a basilar skull fracture?',correct:'Battle’s sign',incorrect:['Cullen’s sign','Grey Turner’s sign','Kernig’s sign']},
  {q:'After aneurysmal SAH, vasospasm is most likely to occur between:',correct:'Days 3–14',incorrect:['First 24 hours','Days 15–30','After 6 weeks']},
  {q:'Which medication is routinely given after aneurysmal SAH to reduce delayed ischemia risk?',correct:'Nimodipine',incorrect:['Nicardipine','Labetalol','Dopamine']},
  {q:'The efferent limb of the pupillary light reflex is mediated by:',correct:'Oculomotor nerve (CN III)',incorrect:['Optic nerve (CN II)','Trochlear nerve (CN IV)','Abducens nerve (CN VI)']},
  {q:'Extension posturing with arms adducted and pronated indicates:',correct:'Decerebrate rigidity',incorrect:['Decorticate posturing','Opisthotonus','Spastic diplegia']},
  {q:'Preferred sedative for rapid titration to help control ICP is:',correct:'Propofol',incorrect:['Midazolam','Haloperidol','Dexmedetomidine']},
  {q:'Early post‑traumatic seizure prophylaxis (first 7 days) commonly uses:',correct:'Levetiracetam',incorrect:['Valproate','Phenobarbital','Carbamazepine']},
  {q:'Early sign of uncal herniation on exam:',correct:'Ipsilateral fixed, dilated pupil',incorrect:['Contralateral miosis','Bilateral pinpoint pupils','Reactive anisocoria']},
  {q:'When leveling an external ventricular drain (EVD), the transducer is aligned with:',correct:'The external auditory meatus/tragus',incorrect:['The sternal notch','The lateral canthus','The umbilicus']},
  {q:'Standard IV thrombolysis window for ischemic stroke is up to:',correct:'4.5 hours from last known well',incorrect:['6 hours','12 hours','24 hours']},
  {q:'Before IV thrombolysis, blood pressure should be lowered to below:',correct:'185/110 mmHg',incorrect:['220/120 mmHg','200/120 mmHg','160/90 mmHg']},
  {q:'After IV thrombolysis, the BP goal is to maintain below:',correct:'180/105 mmHg',incorrect:['200/120 mmHg','160/90 mmHg','140/80 mmHg']},
  {q:'In selected large‑vessel occlusion strokes (DAWN/DEFUSE 3), thrombectomy may be done up to:',correct:'24 hours',incorrect:['6 hours','12 hours','72 hours']},
  {q:'Neurogenic shock after high cervical SCI typically presents with:',correct:'Hypotension with bradycardia',incorrect:['Hypertension with tachycardia','Fever and leukocytosis','Bradycardia with hypertension']},
  {q:'First‑line short‑term therapy for myasthenic crisis is:',correct:'IVIG (or plasmapheresis)',incorrect:['Propranolol','High‑dose furosemide','Immediate high‑dose prednisone alone']},
  {q:'First‑line medication for convulsive status epilepticus is:',correct:'IV lorazepam',incorrect:['IV phenytoin first','Haloperidol','Mannitol']},
  {q:'In chronic hyponatremia, limit sodium correction over 24 hours to:',correct:'≤ 8–10 mEq/L',incorrect:['15–20 mEq/L','12–18 mEq/L','2–3 mEq/L only']},
  {q:'Serious cerebral complication of rapid osmotic shifts in pediatric DKA is:',correct:'Cerebral edema',incorrect:['Hydrocephalus','Subarachnoid hemorrhage','PRES']},
  {q:'Positioning that helps reduce ICP includes:',correct:'Head of bed ~30° with neutral neck',incorrect:['Trendelenburg','Flat supine with chin flexion','Head‑down tilt']},
  {q:'A simple non‑pharmacologic step to immediately lower ICP is to:',correct:'Loosen tight cervical collars and ensure venous outflow',incorrect:['Give hypotonic fluids','Place in Trendelenburg','Hyperextend the neck']},
  {q:'Reversal agent for opioid‑induced respiratory depression is:',correct:'Naloxone',incorrect:['Flumazenil','Physostigmine','Atropine']},
  {q:'Preferred crystalloid for initial resuscitation in severe TBI is:',correct:'Isotonic normal saline',incorrect:['D5W','0.45% saline','Sterile water']}
];

const QUESTIONS_HE=[
  { q:'מהו הטווח התקין ללחץ תוך-גולגולתי (ICP) במבוגרים?', correct:'5–15 מ"מ כספית', incorrect:['0–5 מ"מ כספית','15–25 מ"מ כספית','25–35 מ"מ כספית'] },
  { q:'איזה מהבאים הוא סימן שכיח לעלייה ב-ICP?', correct:'הטריאדה של קושינג', incorrect:['היפררפלקסיה','ברדיפניאה עם אלקלוזיס','מיוזיס'] },
  { q:'איזה ציון בסולם גלזגו מצביע על פגיעה מוחית חמורה?', correct:'3–8', incorrect:['13–15','9–12','0–3'] },
  { q:'איזה טיפול תרופתי הוא קו ראשון להורדה מהירה של ICP?', correct:'מניטול', incorrect:['פוסיד','ניפדיפין','לוראזפאם'] },
  { q:'אישון חד-צדדי מורחב ולא מגיב מרמז על:', correct:'הרניאציה אונקלית', incorrect:['המטומה אפידורלית ללא הרניאציה','שבץ במוחון','נויריטיס אופטית'] },
  { q:'בחולה TBI היפוטנסיבי הזקוק לאוסמותרפיה, מה עדיף?', correct:'תמיסת מלח היפרטונית 3%', incorrect:['מניטול','D5W','0.45% סליין'] },
  { q:'במהלך היפרוונטילציה קצרה להרניאציה מתפתחת, יעד PaCO₂:', correct:'30–35 מ"מ כספית', incorrect:['20–25 מ"מ כספית','35–40 מ"מ כספית','45–50 מ"מ כספית'] },
  { q:'איך מחשבים CPP?', correct:'MAP − ICP', incorrect:['ICP − MAP','MAP + ICP','SBP − ICP'] },
  { q:'יעד CPP מומלץ ב-TBI קשה:', correct:'60–70 מ"מ כספית', incorrect:['40–50 מ"מ כספית','80–90 מ"מ כספית','30–40 מ"מ כספית'] },
  { q:'ממצא מחשיד לשבר בסיס גולגולת:', correct:'סימן באטל', incorrect:['סימן קאלן','סימן גריי טרנר','סימן קרניג'] },
  { q:'אחרי SAH, מתי סיכון מקסימלי לואזוספזם?', correct:'ימים 3–14', incorrect:['24 השעות הראשונות','ימים 15–30','לאחר 6 שבועות'] },
  { q:'תרופה שגרתית אחרי SAH להפחתת איסכמיה מאוחרת:', correct:'נימודיפין', incorrect:['ניקארדיפין','לבטולול','דופמין'] },
  { q:'הזרוע האפרנטית של רפלקס האור של האישון:', correct:'CN III (אוקולומוטורי)', incorrect:['CN II (עצב הראייה)','CN IV (טרוכלארי)','CN VI (אבדוצנס)'] },
  { q:'יציבה עם אקסטנזיה ופרונציה של הידיים היא:', correct:'דצברציה', incorrect:['דקורטיקציה','אופיסטוטונוס','דיפלגיה ספסטית'] },
  { q:'סדציה מועדפת לשליטה מהירה ב-ICP:', correct:'פרופופול', incorrect:['מידזולם','הלופרידול','דקסמדטומידין'] },
  { q:'מניעת פרכוסים מוקדמים בשבוע הראשון אחרי TBI:', correct:'לבטיראצטם', incorrect:['ולפרואט','פנובארביטל','קרבמזפין'] },
  { q:'סימן מוקדם להרניאציה אונקלית:', correct:'אישון מורחב וקבוע בצד הנגע', incorrect:['מיוזיס קונטרלטרלי','אישונים צרים דו-צדדיים','אניזוקוריה תגובתית'] },
  { q:'יישור טרנסדיוסר של EVD לפי:', correct:'הטרגוס/פתח אוזן חיצונית', incorrect:['החריץ הסטרנלי','הקנטוס הלטרלי','הטבור'] },
  { q:'חלון הזמן לטרומבוליזה IV בשבץ:', correct:'עד 4.5 שעות מהופעה', incorrect:['6 שעות','12 שעות','24 שעות'] },
  { q:'לפני טרומבוליזה IV יעד לחץ דם מתחת ל:', correct:'185/110 מ"מ כספית', incorrect:['220/120','200/120','160/90'] },
  { q:'לאחר טרומבוליזה IV יעד לחץ הדם:', correct:'< 180/105 מ"מ כספית', incorrect:['200/120','160/90','140/80'] },
  { q:'תרומבקטומיה ב-LVO ניתן עד:', correct:'24 שעות', incorrect:['6 שעות','12 שעות','72 שעות'] },
  { q:'שוק נוירוגני אחרי פגיעה צווארית גבוהה:', correct:'היפוטנשן עם ברדיקרדיה', incorrect:['היפרטנשן עם טכיקרדיה','חום וליקוציטוזיס','ברדיקרדיה עם היפרטנשן'] },
  { q:'קו ראשון במשבר מיאסטני:', correct:'IVIG או פלסמהפרזיס', incorrect:['פרופראנולול','פוסיד במינון גבוה','פרדניזון גבוה בלבד'] },
  { q:'קו ראשון בסטטוס אפילפטיקוס:', correct:'לוראזפאם IV', incorrect:['פניטואין קודם','הלופרידול','מניטול'] },
  { q:'בהיפונתרמיה כרונית, תיקון יומי מרבי:', correct:'≤ 8–10 mEq/L ב-24 שעות', incorrect:['15–20 mEq/L','12–18 mEq/L','2–3 mEq/L בלבד'] },
  { q:'סיבוך מוחי מסוכן ב-DKA בילדים:', correct:'בצקת מוחית', incorrect:['הידרוצפלוס','SAH','PRES'] },
  { q:'תנוחה להפחתת ICP:', correct:'הגבהת ראש ~30° וצוואר נייטרלי', incorrect:['טרנדלנבורג','שכיבה שטוחה עם כיפוף צוואר','ראש מטה'] },
  { q:'צעד לא-תרופתי מיידי להורדת ICP:', correct:'שחרור צווארון והבטחת ניקוז ורידי', incorrect:['נוזלים היפוטוניים','טרנדלנבורג','היפראקסטנציה צווארית'] },
  { q:'אנטגוניסט לדיכוי נשימתי מאופיואידים:', correct:'נלוקסון', incorrect:['פלומזניל','פיזוסטיגמין','אטרופין'] },
  { q:'קריסטלואיד מועדף ברסוסיטציה ב-TBI קשה:', correct:'סליין איזוטוני', incorrect:['D5W','0.45% סליין','מים סטריליים'] }
];

// Global mutable array that the game reads from
window.CURRENT_QUESTIONS = JSON.parse(JSON.stringify(QUESTIONS_HE));

// Labels for UI
const UI_EN={
  title:'Neuro ICU Training', start:'Start Game', score:'Score:', time:'Time:', banner:'Approach a glowing bed to receive a scenario.', help:'Help, Nurse!', modal:'Clinical Check', next:'Next', correct:'Correct', incorrect:'Incorrect'
};
UI_EN.moveMsg="Don't worry, I'm coming!";
const UI_HE={
  title:'אימון טיפול נמרץ נוירולוגי', start:'התחל משחק', score:'ניקוד:', time:'זמן:', banner:'התקרב למיטה הזוהרת כדי לקבל תרחיש.', help:'עזרה, אחות!', modal:'בדיקה קלינית', next:'הבא', correct:'נכון', incorrect:'לא נכון'
};
UI_HE.moveMsg='אל תדאגו, אני מגיעה!';

let CURRENT_UI = {...UI_HE};

// ===== Loader → Game switch =====
let gameStarted=false;
const startBtn=document.getElementById('startBtn');
startBtn.addEventListener('click',()=>{
  const ov=document.getElementById('startOverlay');
  ov.style.transition='opacity .25s ease'; ov.style.opacity='0';
  setTimeout(()=>{ ov.style.display='none'; document.getElementById('gameWrapper').style.display='block'; initGame(); },260);
},{once:true});

// ===== Translate toggle =====
const tBtn=document.getElementById('translateBtn');
function setChipLabel(id,label){
  const el=document.getElementById(id);
  if(!el) return; const val=el.querySelector('span')?.outerHTML||''; el.innerHTML = label + ' ' + val;
}
function applyLang(ui, questions, lang){
  // Replace questions in-place so the const reference still works
  window.CURRENT_QUESTIONS.splice(0, window.CURRENT_QUESTIONS.length, ...questions.map(q=>({...q})));
  // Static UI strings
  document.querySelector('#startOverlay h2').textContent=ui.title;
  document.getElementById('startBtn').textContent=ui.start;
  document.querySelector('#hud h1').textContent=ui.title;
  setChipLabel('score', ui.score);
  setChipLabel('timer', ui.time);
  document.getElementById('questionBanner').textContent=ui.banner;
  document.getElementById('helpText').textContent=ui.help;
  document.getElementById('modalTitle').textContent=ui.modal;
  document.getElementById('nextBtn').textContent=ui.next;
  // Direction + lang attr
  document.body.dir = (lang==='he') ? 'rtl' : 'ltr';
  document.documentElement.lang = lang;
  console.log('Language switched to', lang.toUpperCase());
}

// Default is Hebrew (matches existing content)
applyLang(CURRENT_UI, QUESTIONS_HE, 'he');

tBtn.addEventListener('click',()=>{
  if(document.documentElement.lang==='he'){
    CURRENT_UI={...UI_EN}; tBtn.textContent='עברית';
    applyLang(CURRENT_UI, QUESTIONS_EN, 'en');
  } else {
    CURRENT_UI={...UI_HE}; tBtn.textContent='English';
    applyLang(CURRENT_UI, QUESTIONS_HE, 'he');
  }
});

// ===== Game code (runs after reveal) =====
function initGame(){
  const scene=document.getElementById('icuScene');
  const nurse=document.getElementById('nurse');
  const beds=Array.from(document.querySelectorAll('.bed'));
  const hudScoreEl=document.querySelector('#score span');
  const hudBanner=document.getElementById('questionBanner');
  const timerEl=document.querySelector('#timer span');
  const helpText=document.getElementById('helpText');

  const modal=document.getElementById('questionModal');
  const closeModalBtn=document.getElementById('closeModalBtn');
  const qText=document.getElementById('questionText');
  const optionsBox=document.getElementById('options');
  const resultMsg=document.getElementById('resultMsg');

  // Important: keep a const pointing to the mutable global array
  const QUESTIONS = window.CURRENT_QUESTIONS;
  console.log((document.documentElement.lang==='he'?'נטען מאגר שאלות. סה"כ: ':'Loaded questions. Total: ')+QUESTIONS.length);

  let score=0; function updateScore(){ if(hudScoreEl) hudScoreEl.textContent=String(score); }
  let activeIdx=-1;
  function placeHelpText(bedEl){ if(!bedEl) return; const s=scene.getBoundingClientRect(); const r=bedEl.getBoundingClientRect(); const cx=r.left - s.left + r.width/2; const top=r.top - s.top - 18; helpText.style.left=(cx - 60) + 'px'; helpText.style.top= top + 'px'; helpText.style.display='block'; }
  function setActiveBed(idx){ activeIdx=idx; beds.forEach((b,i)=>b.classList.toggle('glow', i===idx)); if(hudBanner) hudBanner.textContent=CURRENT_UI.banner; placeHelpText(beds[activeIdx]); }
  function chooseNextBed(exclude){ const choices=beds.map((_,i)=>i).filter(i=>i!==exclude); return choices.length?choices[Math.floor(Math.random()*choices.length)]:exclude; }
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
  let used=new Set(); function pickQuestion(){ if(used.size===QUESTIONS.length) used.clear(); let idx; do{ idx=Math.floor(Math.random()*QUESTIONS.length);} while(used.has(idx)); used.add(idx); return QUESTIONS[idx]; }
  function renderQuestion(q){ qText.textContent=q.q; optionsBox.innerHTML=''; shuffle([q.correct,...q.incorrect]).forEach(txt=>{ const btn=document.createElement('button'); btn.textContent=txt; btn.style.cssText='text-align:left;background:#1f2937;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:10px;cursor:pointer;'; btn.onclick=()=>handleAnswer(btn,txt===q.correct); optionsBox.appendChild(btn); }); resultMsg.textContent=''; }
  function openModal(){ modal.style.display='flex'; helpText.style.display='none'; }
  function closeModal(){ modal.style.display='none'; resultMsg.textContent=''; }
  function handleAnswer(btn,isCorrect){ optionsBox.querySelectorAll('button').forEach(b=>b.disabled=true); if(isCorrect){ score+=10; updateScore(); resultMsg.textContent=CURRENT_UI.correct; btn.style.background='#16a34a'; } else { score-=5; updateScore(); resultMsg.textContent=CURRENT_UI.incorrect; btn.style.background='#dc2626'; } setTimeout(()=>{ closeModal(); setActiveBed(chooseNextBed(activeIdx)); }, 800); }
  closeModalBtn.onclick=closeModal;

  // Movement helpers
  function center(el){ const r=el.getBoundingClientRect(); const s=scene.getBoundingClientRect(); return {x:r.left-s.left+r.width/2,y:r.top-s.top+r.height/2}; }
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const setNursePos=(x,y)=>{ nurse.style.left=x+'px'; nurse.style.top=y+'px'; };
  const getNursePos=()=>({x:parseFloat(nurse.style.left)||0,y:parseFloat(nurse.style.top)||0});

  // Initialize nurse pixel position and first bed
  const s=scene.getBoundingClientRect(); setNursePos(s.width*0.45, s.height*0.65);
  setActiveBed(Math.floor(Math.random()*beds.length));

  // Click-to-move with easing; pep-talk bubble
  let target=null; let moving=false;
  scene.addEventListener('pointerdown', e=>{
    const rect=scene.getBoundingClientRect(); const nr=nurse.getBoundingClientRect();
    const prevX=(parseFloat(nurse.style.left)||rect.width*0.45)+nr.width/2; const prevY=(parseFloat(nurse.style.top)||rect.height*0.65);
    const msg=document.createElement('div'); msg.className='travelMsg'; msg.textContent=CURRENT_UI.moveMsg; msg.style.left=prevX+'px'; msg.style.top=prevY+'px'; msg.style.transform='translate(-50%,-100%)'; scene.appendChild(msg); setTimeout(()=>msg.remove(),900);
    const minY=rect.height*0.42; const tx=Math.max(0,Math.min(e.clientX-rect.left-nr.width/2, rect.width-nr.width)); const ty=Math.max(minY,Math.min(e.clientY-rect.top-nr.height/2, rect.height-nr.height));
    target={x:tx,y:ty}; moving=true; nurse.classList.remove('idle');
  });

  function maybeTriggerQuestion(){ const activeBed=beds[activeIdx]; if(!activeBed) return; const a=center(nurse), b=center(activeBed); const d=Math.hypot(a.x-b.x,a.y-b.y); const modalClosed = (!modal.style.display || modal.style.display==='none'); if(d<120 && modalClosed){ renderQuestion(pickQuestion()); openModal(); moving=false; } }

  (function step(){ requestAnimationFrame(step); if(!moving || !target){ if(!modal.style.display || modal.style.display==='none') nurse.classList.add('idle'); return;} const pos=getNursePos(); const dx=target.x-pos.x, dy=target.y-pos.y; const dist=Math.hypot(dx,dy); if(dist<1.5){ setNursePos(target.x,target.y); moving=false; nurse.classList.add('idle'); return;} const ease=0.12; setNursePos(pos.x+dx*ease, pos.y+dy*ease); maybeTriggerQuestion(); })();

  // Timer
  let timerHandle=null; const startTimer=()=>{ if(timerHandle) clearInterval(timerHandle); const t0=Date.now(); timerHandle=setInterval(()=>{ const t=Math.floor((Date.now()-t0)/1000); const mm=String(Math.floor(t/60)).padStart(2,'0'); const ss=String(t%60).padStart(2,'0'); if(timerEl) timerEl.textContent=mm+':'+ss; },1000); };
  startTimer();
}
</script>
</body>
</html>
